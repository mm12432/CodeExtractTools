import {
    Button,
    VerticalBox,
    LineEdit,
    TextEdit,
    GroupBox,
    HorizontalBox,
    CheckBox,
    ScrollView,
    StandardListView,
} from "std-widgets.slint";

export struct LanguageStats {
    name: string,
    count: int,
    enabled: bool,
}

export struct FileItem {
    path: string,
    size: string,
    excluded: bool,
}

export component AppWindow inherits Window {
    title: "è½¯è‘—ä»£ç æå–åŠ©æ‰‹ Pro (Rust Native)";
    preferred-width: 1200px;
    preferred-height: 800px;

    // å›è°ƒ
    callback select-dir();
    callback start-scan();
    callback start-extract();
    callback toggle-language(string, bool);
    callback add-exclude-rule(string);
    callback remove-exclude-rule(int);
    callback start-export();

    // çŠ¶æ€å±æ€§
    in-out property <string> root-path: "æœªé€‰æ‹©ç›®å½•";
    in-out property <float> progress: 0.0;
    in-out property <string> status-msg: "å°±ç»ª";
    in-out property <[LanguageStats]> languages: [];
    in-out property <[string]> exclude-rules: [".git", "node_modules", "bin", "obj", "target"];
    
    // å½•å…¥ä¿¡æ¯
    in-out property <string> software-name: "";
    in-out property <string> app-version: "V1.0";

    // ç»Ÿè®¡æ•°æ®
    in-out property <int> total-files: 0;
    in-out property <int> total-lines: 0;
    in-out property <int> cleaned-lines: 0;
    in-out property <int> estimated-pages: 0;
    in-out property <string> preview-text: "è¯·é€‰æ‹©ç›®å½•å¹¶å¼€å§‹åˆ†æ...";
    HorizontalBox {
        padding: 15px;
        spacing: 15px;

        // å·¦ä¾§æ ï¼šæ–‡ä»¶è¿‡æ»¤ä¸è§„åˆ™ (300px)
        VerticalBox {
            width: 320px;
            spacing: 12px;
            GroupBox {
                title: "1. é¡¹ç›®å…¥å£";
                VerticalBox {
                    HorizontalBox {
                        LineEdit {
                            text: root-path;
                            read-only: true;
                        }

                        Button {
                            text: "æµè§ˆ";
                            width: 60px;
                            clicked => {
                                select-dir()
                            }
                        }
                    }

                    Button {
                        text: "ğŸ” ç«‹å³æ‰«æé¡¹ç›®ç»“æ„";
                        primary: true;
                        clicked => {
                            start-scan()
                        }
                    }
                }
            }

            GroupBox {
                title: "2. æ’é™¤è§„åˆ™ (Gitignore é£æ ¼)";
                VerticalBox {
                    spacing: 8px;
                    HorizontalBox {
                        rule_input := LineEdit {
                            placeholder-text: "è¾“å…¥è§„åˆ™ (å¦‚ *.log)";
                        }

                        Button {
                            text: "æ·»åŠ ";
                            clicked => {
                                if (rule_input.text != "") {
                                    add-exclude-rule(rule_input.text);
                                    rule_input.text = "";
                                }
                            }
                        }
                    }

                    ScrollView {
                        height: 150px;
                        VerticalBox {
                            alignment: start;
                            for rule[idx] in exclude-rules: HorizontalBox {
                                Text {
                                    text: rule;
                                    vertical-alignment: center;
                                }

                                Rectangle { }

                                Button {
                                    text: "Ã—";
                                    width: 30px;
                                    clicked => {
                                        remove-exclude-rule(idx)
                                    }
                                }
                            }
                        }
                    }
                }
            }

            GroupBox {
                title: "3. è¯­è¨€ç­›é€‰ (æ™ºèƒ½è¯†åˆ«)";
                ScrollView {
                    height: 200px;
                    VerticalBox {
                        alignment: start;
                        for lang in languages: CheckBox {
                            text: lang.name + " (" + lang.count + ")";
                            checked: lang.enabled;
                            toggled => {
                                toggle-language(lang.name, self.checked)
                            }
                        }
                        if (languages.length == 0): Text {
                            text: "æš‚æ— æ‰«æç»“æœ";
                            font-italic: true;
                            color: #888;
                        }
                    }
                }
            }
        }

        // ä¸­é—´æ ï¼šç»Ÿè®¡ä¸é¢„è§ˆ (ä¸»æ˜¾ç¤ºåŒº)
        VerticalBox {
            spacing: 15px;
            GroupBox {
                title: "é…ç½®ä¸æŒ‡æ ‡";
                VerticalBox {
                    spacing: 12px;
                    HorizontalBox {
                        spacing: 20px;
                        CheckBox {
                            text: "å»æ³¨é‡Š";
                            checked: true;
                        }

                        CheckBox {
                            text: "å»å¯¼åŒ…/å¼•ç”¨";
                            checked: true;
                        }

                        CheckBox {
                            text: "å‹ç¼©ç©ºè¡Œ";
                            checked: true;
                        }

                        Rectangle { } // spacer
                        HorizontalBox {
                            Text {
                                text: "é«˜çº§æ­£åˆ™: ";
                                vertical-alignment: center;
                            }

                            LineEdit {
                                placeholder-text: "è‡ªå®šä¹‰è¿‡æ»¤æ­£åˆ™...";
                                width: 150px;
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: #ddd;
                    } // åˆ†å‰²çº¿
                    
                    HorizontalBox {
                        alignment: space-around;
                        VerticalBox {
                            Text {
                                text: "åŸå§‹è¡Œæ•°";
                                font-size: 14px;
                                color: #666;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: total-lines;
                                font-size: 24px;
                                font-weight: 700;
                                horizontal-alignment: center;
                            }
                        }

                        VerticalBox {
                            Text {
                                text: "æ¸…æ´—åè¡Œæ•°";
                                font-size: 14px;
                                color: #666;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: cleaned_lines;
                                font-size: 24px;
                                font-weight: 700;
                                color: #2e7d32;
                                horizontal-alignment: center;
                            }
                        }

                        VerticalBox {
                            Text {
                                text: "é¢„è®¡é¡µæ•°";
                                font-size: 14px;
                                color: #666;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: estimated-pages;
                                font-size: 24px;
                                font-weight: 700;
                                color: estimated-pages >= 60 ? #2e7d32 : #d32f2f;
                                horizontal-alignment: center;
                            }
                        }

                        VerticalBox {
                            Text {
                                text: "æ–‡ä»¶æ€»æ•°";
                                font-size: 14px;
                                color: #666;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: total-files;
                                font-size: 24px;
                                font-weight: 700;
                                horizontal-alignment: center;
                            }
                        }
                    }
                }
            }

            GroupBox {
                title: "ä»£ç æŠ½å–é¢„è§ˆ (å‰ 2000 å­—ç¬¦)";
                VerticalBox {
                    TextEdit {
                        text: preview-text;
                        read-only: true;
                        font-family: "Consolas";
                        font-size: 13px;
                    }
                }
            }
        }

        // å³ä¾§æ /åº•éƒ¨æ æ•´åˆï¼šç”Ÿæˆæ“ä½œ
        VerticalBox {
            width: 260px;
            spacing: 15px;
            GroupBox {
                title: "4. è½¯è‘—ç”³è¯·ä¿¡æ¯";
                VerticalBox {
                    spacing: 10px;
                    Text {
                        text: "è½¯ä»¶å…¨ç§°:";
                    }

                    LineEdit {
                        text: software-name;
                        edited(t) => {
                            software-name = t
                        }
                    }

                    Text {
                        text: "è½¯ä»¶ç‰ˆæœ¬:";
                    }

                    LineEdit {
                        text: app-version;
                        edited(t) => {
                            app-version = t
                        }
                    }
                }
            }

            GroupBox {
                title: "æ“ä½œ";
                VerticalBox {
                    spacing: 12px;
                    status_text := Text {
                        text: status-msg;
                        wrap: word-wrap;
                        color: #555;
                        font-size: 12px;
                    }
                    
                    // è¿›åº¦æ¡
                    Rectangle {
                        height: 8px;
                        background: #eee;
                        border-radius: 4px;
                        Rectangle {
                            x: 0;
                            width: parent.width * progress;
                            height: parent.height;
                            background: #2196f3;
                            border-radius: 4px;
                        }
                    }

                    Button {
                        text: "âš™ è¿è¡Œæ¸…æ´—ä¸åˆ†æ";
                        primary: true;
                        height: 40px;
                        clicked => {
                            start-extract()
                        }
                    }

                    Button {
                        text: "ğŸ“„ ä¸€é”®å¯¼å‡º Word (.docx)";
                        enabled: estimated_pages > 0;
                        height: 40px;
                        clicked => {
                            start-export()
                        }
                    }
                }
            }

            Rectangle { } // spacer
        }
    }
}
